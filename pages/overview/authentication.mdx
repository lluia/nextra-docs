import { Callout, Tabs } from "nextra/components";
import { Link } from "../../components/Link/Link";
import { Code } from "../../components/Code/Code";
import { ListDisclosure } from "../../components/ListDisclosure/ListDisclosure";
import manifest from "../data/manifest.json";

# Authenticating users

<Callout>
  Auth.js discourages the use of passwords due to the inherent security risks of
  the username-password model. Passwords are still supported through the
  [External auth]((#setup-with-external-auth)) but we strongly encourage to
  setup a combination of **Oauth + Passwordless** for authentication.
</Callout>

Before start setting up Auth.js, you need to decide how you're gonna authenticate users in your application. Auth.js supports <u>three main authentication paradigms</u>:

- [Oauth](#setup-oauth) ( _Sign in with Google, Github, LinkedIn, etc..._ )
- [Paswordless](#setup-paswordless) ( _Magic links, OTP codes, WebAuthn, etc..._ )
- [External auth](#setup-with-external-auth) ( _Integrating with external APIs, etc..._ )

<br />

<details>
<summary>
<b>Why Auth.js recommends OAuth as the main authentication method for your application?</b>
</summary>

OAuth providers spend significant amounts of money, time, and engineering effort to build abuse detection ( _bot-protection, rate-limiting_ ), password management ( _password reset, credential stuffing, rotation_ ), data security ( _encryption/salting, strength validation_ ), and much more. It is likely that your application would benefit from leveraging these battle-tested solutions rather than try to rebuild them from scratch.

</details>
<details>
<summary>
<b>Do I need a database?</b>
</summary>

Auth.js by default uses [JSON Web Tokens](https://jwt.io/) for saving the user's session so you don't need to setup a database for authenticating users ( _all our JWT tokens are encrypted by default with A256GCM_ ). However, if you want to set up a database, you can use one of our official database adapters or create your own. The database will be used <u>to persist the user's session</u>. You can force the usage of JWT when using a database through the configuration options.

</details>
<details>
<summary>
<b>Can I set up more than one authentication method?</b>
</summary>

OAuth providers spend significant amounts of money, time, and engineering effort to build abuse detection ( _bot-protection, rate-limiting_ ), password management ( _password reset, credential stuffing, rotation_ ), data security ( _encryption/salting, strength validation_ ), and much more. It is likely that your application would benefit from leveraging these battle-tested solutions rather than try to rebuild them from scratch.

</details>

## Setup OAuth

<Callout type="info">
  Can't find the OAuth provider you're looking for? In that case, you'll need to
  build your own provider, which is easy. [Learn
  how](/tutorials/deep-dive/oauth-github-setup). Auth.js can be setup with any
  OAuth provider as long as they support **OAuth 2**.
</Callout>

Auth.js has built-in support for a lot of OAuth providers, you can see the full list below and click in one of them to learn how to configure it.

<ListDisclosure limit={8}>
  {Object.entries(manifest.providers).map(([id, name]) => (
    <Link
      href={`/reference/oauth-providers/${id}`}
      key={name}
      className="p-4 border border-solid border-slate-200 rounded-lg flex flex-col items-center justify-between w-36 shadow-lg h-32"
    >
      <img src={`/img/providers/${id}.svg`} className="w-11 mt-2" />
      <div class="text-sm text-center">{name}</div>
    </Link>
  ))}
</ListDisclosure>

Start by creating a Auth.js config file in the root of your application:

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth";
// In this example we're using Github, if you're using another provider, for example, like Google, it'll be:
// `import Google from "next-auth/providers/google"`
import GitHub from "next-auth/providers/github";

export const { signIn, auth } = NextAuth({
  providers: [GitHub],
});
```

</Code.Next>
</Code>

<Callout type="warning">
  Note that, if you haven't done it before, setting up OAuth from scratch can be
  tricky. <u>We strongly recommend</u> you read our deep dive guide on [how to
  setup Github OAuth with Auth.js](/tutorials/oauth-github-setup). The
  instructions will be the same for any OAuth provider, only differing how you
  register your application in the provider's dashboard.
</Callout>

If you run the app, this won't work yet. You need to register your application in the OAuth provider's dashboard. For instance, for Github you would need to follow [these instructions](https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/creating-an-oauth-app) to register the app.

When registering, make sure you insert a callback URL with the following shape:

<Code>
<Code.Next>

```
[origin]/api/auth/callback/[provider]
```

In this case, given we want to try our application locally, it would be the provider's name (always in [kebab case](https://www.theserverside.com/definition/Kebab-case), so for Github → `github`):

```
[origin]/api/auth/callback/[provider_name] → https://localhost:3000/api/auth/callback/github
```

</Code.Next>
<Code.Svelte>

```
[origin]/api/callback/[provider]
```

In this case, given we want to try our application locally, it would be the provider's name (always in [kebab case](https://www.theserverside.com/definition/Kebab-case), so for Github → `github`):

```
[origin]/api/callback/[provider_name] → https://localhost:3000/api/callback/github
```

</Code.Svelte>
</Code>

Once registered, you should get a **Client ID** and **Client Secret**. Add those in your application environment file (`.env.local` for Next.js) like so:

```bash filename=".env.local"
AUTH_GITHUB_ID={CLIENT_ID}
AUTH_GITHUB_SECRET={CLIENT_SECRET}
```

Auth.js will automatically pick up these. You can [also use a different name for the environment variables](/concepts/environment-variables#oauth-variables) if needed.

Now add a sign in button somewhere in your application:

<Code>
<Code.Next>

```tsx filename="./components/sign-in.tsx"
"use client";

import { signIn } from "../../auth.ts";

export function SignIn() {
  return (
    <form
      action={async () => {
        "use server";
        await signIn();
      }}
    >
      <button type="submit">Sign In</button>
    </form>
  );
}
```

</Code.Next>
</Code>

And start your application, clicking the sign in button we just added. If all went well, you should be redirected to Github (or the provider you chose) and once authenticated redirected back to the app already authenticated.

<Callout type="info">
  You can click on the provider cards above, or visit [the provider's API
  reference page](http://localhost:3000/reference/oauth-providers) to see the
  configuration options you can supply to the provider.
</Callout>

## Setup Paswordless

...

## Setup with external auth

To setup Auth.js with external authentication we need to use the `CredentialsProvider`, which is designed to forward any inserted credentials (.i.e username/password) in the sign in form to your authentication service. This provider is very flexible, and can be easily setup to work with modern authentication methods like for example [WebAuthn](https://webauthn.io/).

<Callout type="warning">
  The functionality provided by the `CredentialsProvider` is intentionally
  limited in favour of flexibility and to discourage the use of passwords due to
  the inherent security risks associated with them (and the additional
  complexity associated with supporting usernames and passwords).
</Callout>

Integrating the Credentials Provider is as simple as initializing it in the Auth.js configuration file:

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth";
import Credentials from "next-auth/providers/credentials";

export const {
  handlers: { GET, POST },
  auth,
} = NextAuth({
  providers: [
    Credentials({
      // `credentials` will usually contain the inserted username/password
      // in the sign in form
      async authorize(credentials) {
        const authResponse = await fetch("/users/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(credentials),
        });

        if (!authResponse.ok) {
          return null;
        }

        const user = await authResponse.json();

        return user;
      },
    }),
  ],
});
```

```ts filename="app/api/auth/[...nextauth]/route.ts"
export { GET, POST } from "./auth";
export const runtime = "edge"; // optional
```

</Code.Next>
</Code>

Note that we only had to define a single `authorize` method that is in charge of receiving the credentials inserted by the user and call whatever authentication service we want to use. Auth.js will then be in charge of managing the user session for us.

- [Check the Credentials Provider options](/reference/core/providers/credentials) for further customization

<Callout type="info">
  If you're using TypeScript, you can [augment the `User`
  interface](/getting-started/typescript#module-augmentation) to match the
  response of your `authorize` callback, so whenever you read the user in other
  callbacks (like the `jwt`) the type will match correctly.
</Callout>
